name: Deploy Backend

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  BACKEND_IMAGE: me-system-backend

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Backend Docker image
        run: |
          docker build -t ${{ env.BACKEND_IMAGE }} .
          docker save -o backend.tar ${{ env.BACKEND_IMAGE }}

      - name: Upload Backend image
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: backend.tar
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Backend image
        uses: actions/download-artifact@v4
        with:
          name: backend-image
          path: ./artifacts

      - name: Create SSH directory
        run: mkdir -p ~/.ssh

      - name: Add Host to Known Hosts
        run: ssh-keyscan ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Set Correct Permissions
        run: chmod 600 ~/.ssh/known_hosts

      - name: Copy Backend image to server
        run: |
          scp -o ServerAliveInterval=60 -o ServerAliveCountMax=60 \
            ./artifacts/backend.tar \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }}:/tmp/

      - name: Copy deployment files to server
        run: |
          scp -o ServerAliveInterval=60 -o ServerAliveCountMax=60 \
            docker-compose.prod.yml \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }}:~/me_system/

      - name: Deploy Backend to DigitalOcean
        run: |
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=60 \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << 'EOF'
            set -e
            
            # Navigate to deployment directory
            cd ~/me_system
            
            # Load Backend Docker image
            echo "Loading Backend Docker image..."
            docker load -i /tmp/backend.tar
            
            # Clean up transferred image
            rm /tmp/backend.tar
            
            # Create .env file from secrets (if not exists)
            if [ ! -f .env ]; then
              echo "Creating .env file..."
              cat > .env << 'ENVEOF'
          DEBUG=${{ secrets.DEBUG }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          NEXT_PUBLIC_API_URL=http://backend:8000
          ENVEOF
            fi
            
            # Stop existing backend container
            echo "Stopping existing backend container..."
            docker-compose -f docker-compose.prod.yml stop backend || true
            docker-compose -f docker-compose.prod.yml rm -f backend || true
            
            # Start database if not running
            echo "Ensuring database is running..."
            docker-compose -f docker-compose.prod.yml up -d db
            
            # Wait for database to be ready
            echo "Waiting for database..."
            sleep 10
            
            # Start new backend container
            echo "Starting new backend container..."
            docker-compose -f docker-compose.prod.yml up -d backend
            
            # Wait for backend to be ready
            sleep 5
            
            # Run migrations
            echo "Running migrations..."
            docker-compose -f docker-compose.prod.yml exec -T backend python manage.py migrate
            
            # Collect static files
            echo "Collecting static files..."
            docker-compose -f docker-compose.prod.yml exec -T backend python manage.py collectstatic --noinput
            
            # Clean up old images
            echo "Cleaning up old images..."
            docker image prune -f
            
            echo "Backend deployment completed successfully!"
          EOF

